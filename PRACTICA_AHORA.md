# üöÄ Pr√°ctica de Validaci√≥n y Trackeo - EJECUTA AHORA

## ‚ö†Ô∏è IMPORTANTE: Debes iniciar la API primero

### Paso 1: Abrir 3 Terminales

#### Terminal 1: Iniciar la API
```bash
cd /mnt/c/Users/aleja/solicitudes-api
python wsgi.py
```

Deber√≠as ver:
```
 * Running on http://127.0.0.1:5000
 * Press CTRL+C to quit
```

**‚ö†Ô∏è NO CIERRES ESTA TERMINAL** - La API debe estar corriendo

---

#### Terminal 2: Ver Logs en Tiempo Real
```bash
cd /mnt/c/Users/aleja/solicitudes-api
tail -f logs/solicitudes_api.log
```

Si el directorio `logs/` no existe, cr√©alo:
```bash
mkdir -p logs
```

**‚ö†Ô∏è DEJA ESTA TERMINAL ABIERTA** - Ver√°s los logs aparecer aqu√≠

---

#### Terminal 3: Ejecutar Pruebas

Ahora s√≠, vamos a practicar! Ejecuta estos comandos uno por uno:

---

## üß™ EJERCICIO 1: Error 400 - JSON Mal Formado

**Concepto**: El JSON est√° roto sint√°cticamente

```bash
curl -X POST http://localhost:5000/api/usuarios/registro \
  -H "Content-Type: application/json" \
  -d '{"email":"test@test.com", "password":"123456'
```

**¬øQu√© observar?**
1. ‚úÖ C√≥digo HTTP: **400 Bad Request**
2. ‚úÖ En Terminal 2 (logs): Ver√°s el error registrado
3. ‚úÖ Mensaje: "El cuerpo de la solicitud no es un JSON v√°lido"

**Resultado esperado**:
```json
{
  "success": false,
  "timestamp": "2025-10-31T...",
  "request_id": "uuid-...",
  "error": {
    "code": "INVALID_JSON",
    "message": "El cuerpo de la solicitud no es un JSON v√°lido",
    "details": {...}
  }
}
```

**Pregunta para ti**: ¬øPor qu√© 400 y no 422?
**Respuesta**: Porque el JSON est√° **MAL FORMADO** (sintaxis rota), no es un problema de validaci√≥n.

---

## üß™ EJERCICIO 2: Error 422 - Email Inv√°lido

**Concepto**: JSON bien formado, pero datos incorrectos

```bash
curl -X POST http://localhost:5000/api/usuarios/registro \
  -H "Content-Type: application/json" \
  -d '{
    "email": "email-sin-arroba",
    "password": "123456",
    "nombre": "Juan"
  }'
```

**¬øQu√© observar?**
1. ‚úÖ C√≥digo HTTP: **422 Unprocessable Entity**
2. ‚úÖ JSON est√° bien formado (por eso NO es 400)
3. ‚úÖ Pero el email no tiene @ (por eso ES 422)
4. ‚úÖ Error espec√≠fico: "El formato del email no es v√°lido"

**Resultado esperado**:
```json
{
  "success": false,
  "timestamp": "2025-10-31T...",
  "request_id": "uuid-...",
  "error": {
    "code": "VALIDATION_ERROR",
    "message": "Los datos proporcionados no son v√°lidos",
    "details": {
      "errors": {
        "email": ["El formato del email no es v√°lido"]
      }
    }
  }
}
```

**Copia el `request_id`** - Lo usaremos en el ejercicio 6

---

## üß™ EJERCICIO 3: Error 422 - Password Muy Corta

```bash
curl -X POST http://localhost:5000/api/usuarios/registro \
  -H "Content-Type: application/json" \
  -d '{
    "email": "test@test.com",
    "password": "123",
    "nombre": "Juan"
  }'
```

**¬øQu√© observar?**
1. ‚úÖ C√≥digo HTTP: **422 Unprocessable Entity**
2. ‚úÖ Error: "La contrase√±a debe tener al menos 6 caracteres"

**Pregunta para ti**: ¬øCu√°ntos caracteres tiene "123"?
**Respuesta**: 3 caracteres (m√≠nimo es 6)

---

## üß™ EJERCICIO 4: Error 422 - M√∫ltiples Errores a la Vez

**Concepto**: Todos los errores se retornan juntos (mejor UX)

```bash
curl -X POST http://localhost:5000/api/usuarios/registro \
  -H "Content-Type: application/json" \
  -d '{
    "email": "invalido",
    "password": "12"
  }'
```

**¬øQu√© observar?**
1. ‚úÖ **3 errores en una sola respuesta**:
   - Email inv√°lido (sin @)
   - Password muy corta (2 caracteres)
   - Falta el campo "nombre"

**Resultado esperado**:
```json
{
  "error": {
    "code": "VALIDATION_ERROR",
    "details": {
      "errors": {
        "email": ["El formato del email no es v√°lido"],
        "password": ["La contrase√±a debe tener al menos 6 caracteres"],
        "nombre": ["El nombre es requerido"]
      }
    }
  }
}
```

**‚ú® Observa**: No necesitas hacer 3 requests para ver los 3 errores. Todos vienen juntos!

---

## üß™ EJERCICIO 5: √âxito 201 - Registro Correcto

**Concepto**: Cuando todo est√° bien, c√≥digo 201 Created

```bash
curl -X POST http://localhost:5000/api/usuarios/registro \
  -H "Content-Type: application/json" \
  -d '{
    "email": "usuario1@test.com",
    "password": "123456",
    "nombre": "Juan"
  }'
```

**¬øQu√© observar?**
1. ‚úÖ C√≥digo HTTP: **201 Created**
2. ‚úÖ `success: true`
3. ‚úÖ Recibes `access_token` y `refresh_token`
4. ‚úÖ Timestamp en formato ISO 8601

**Resultado esperado**:
```json
{
  "success": true,
  "timestamp": "2025-10-31T...",
  "message": "Usuario registrado exitosamente",
  "data": {
    "usuario": {
      "id": 1,
      "email": "usuario1@test.com",
      "nombre": "Juan",
      "rol": "empleado"
    },
    "access_token": "eyJ0eXAiOiJKV1QiLCJh...",
    "refresh_token": "eyJ0eXAiOiJKV1QiLCJh...",
    "token_type": "Bearer"
  }
}
```

**Guarda el token** para ejercicios posteriores:
```bash
# En Linux/Mac
TOKEN="eyJ0eXAiOiJKV1QiLCJh..."  # Copia el access_token aqu√≠

# O gu√°rdalo en un archivo
echo "eyJ0eXAiOiJKV1QiLCJh..." > token.txt
```

---

## üß™ EJERCICIO 6: Trackeo con Request ID

**Concepto**: Cada error tiene un ID √∫nico para tracking

**Paso 1**: Provoca un error y guarda la respuesta
```bash
curl -X POST http://localhost:5000/api/usuarios/registro \
  -H "Content-Type: application/json" \
  -d '{"email":"invalido","password":"12"}' > error.json
```

**Paso 2**: Ver la respuesta completa
```bash
cat error.json
```

**Paso 3**: Busca el campo `request_id` (ser√° algo como `a1b2c3d4-e5f6-7890-abcd-ef1234567890`)

**Paso 4**: B√∫scalo en los logs
```bash
# Reemplaza REQUEST_ID con el valor que copiaste
grep "a1b2c3d4-e5f6-7890-abcd-ef1234567890" logs/solicitudes_api.log
```

**Paso 5**: Ver contexto completo (10 l√≠neas antes y despu√©s)
```bash
grep -A 10 -B 10 "a1b2c3d4-e5f6-7890-abcd-ef1234567890" logs/solicitudes_api.log
```

**‚ú® Beneficio**: En producci√≥n, el usuario te da su `request_id` y t√∫ encuentras exactamente qu√© pas√≥!

---

## üß™ EJERCICIO 7: Error 409 - Conflicto (Email Duplicado)

**Concepto**: La operaci√≥n genera un conflicto con el estado actual

**Paso 1**: Registra un usuario (ya lo hicimos en ejercicio 5)

**Paso 2**: Intenta registrar el mismo email otra vez
```bash
curl -X POST http://localhost:5000/api/usuarios/registro \
  -H "Content-Type: application/json" \
  -d '{
    "email": "usuario1@test.com",
    "password": "123456",
    "nombre": "Pedro"
  }'
```

**¬øQu√© observar?**
1. ‚úÖ C√≥digo HTTP: **409 Conflict**
2. ‚úÖ Error: "El email ya est√° registrado en el sistema"
3. ‚úÖ C√≥digo espec√≠fico: `USER_ALREADY_EXISTS`

**Pregunta para ti**: ¬øPor qu√© 409 y no 422?
**Respuesta**: Porque NO es un error de validaci√≥n. El email es v√°lido, pero YA EXISTE (conflicto de estado).

---

## üß™ EJERCICIO 8: Error 401 - Credenciales Incorrectas

**Concepto**: Autenticaci√≥n fallida

```bash
curl -X POST http://localhost:5000/api/usuarios/login \
  -H "Content-Type: application/json" \
  -d '{
    "email": "usuario1@test.com",
    "password": "password_incorrecta"
  }'
```

**¬øQu√© observar?**
1. ‚úÖ C√≥digo HTTP: **401 Unauthorized**
2. ‚úÖ Error: "Email o contrase√±a incorrectos"
3. ‚úÖ C√≥digo espec√≠fico: `INVALID_CREDENTIALS`

**Pregunta para ti**: ¬øPor qu√© 401 y no 403?
**Respuesta**:
- **401** = No est√°s autenticado (credenciales incorrectas)
- **403** = Est√°s autenticado pero sin permisos

---

## üß™ EJERCICIO 9: √âxito 200 - Login Correcto

```bash
curl -X POST http://localhost:5000/api/usuarios/login \
  -H "Content-Type: application/json" \
  -d '{
    "email": "usuario1@test.com",
    "password": "123456"
  }'
```

**¬øQu√© observar?**
1. ‚úÖ C√≥digo HTTP: **200 OK**
2. ‚úÖ `success: true`
3. ‚úÖ Recibes nuevos tokens

---

## üß™ EJERCICIO 10: Error 401 - Token Inv√°lido

**Concepto**: Token JWT malformado o expirado

```bash
curl -X GET http://localhost:5000/api/usuarios/perfil \
  -H "Authorization: Bearer token_invalido_xyz123"
```

**¬øQu√© observar?**
1. ‚úÖ C√≥digo HTTP: **401 Unauthorized**
2. ‚úÖ Error: "Not enough segments" (token malformado)
3. ‚úÖ C√≥digo espec√≠fico: `JWT_ERROR`

---

## üß™ EJERCICIO 11: √âxito 200 - Acceso con Token V√°lido

**Prerequisito**: Debes tener un token del ejercicio 5 o 9

```bash
# Reemplaza TOKEN con tu token real
curl -X GET http://localhost:5000/api/usuarios/perfil \
  -H "Authorization: Bearer eyJ0eXAiOiJKV1QiLCJh..."
```

**¬øQu√© observar?**
1. ‚úÖ C√≥digo HTTP: **200 OK**
2. ‚úÖ Recibes tus datos de usuario

---

## üß™ EJERCICIO 12: Ver Logs Filtrados

Ahora que has generado varios errores, vamos a analizarlos:

```bash
# Ver todos los errores
grep "ERROR" logs/solicitudes_api.log

# Ver solo errores de validaci√≥n
grep "VALIDATION_ERROR" logs/solicitudes_api.log

# Contar cu√°ntos errores de cada tipo
grep -o '"code": "[^"]*"' logs/solicitudes_api.log | sort | uniq -c

# Ver √∫ltimos 20 errores
grep "ERROR" logs/solicitudes_api.log | tail -20
```

---

## üìä RESUMEN DE C√ìDIGOS HTTP QUE PRACTICASTE

| C√≥digo | Nombre | Cu√°ndo | Ejercicio |
|--------|--------|--------|-----------|
| 200 | OK | Login exitoso, GET perfil | 9, 11 |
| 201 | Created | Registro exitoso | 5 |
| 400 | Bad Request | JSON mal formado | 1 |
| 401 | Unauthorized | Credenciales incorrectas, token inv√°lido | 8, 10 |
| 409 | Conflict | Email duplicado | 7 |
| 422 | Validation Error | Datos inv√°lidos | 2, 3, 4 |

---

## ‚úÖ CHECKLIST DE PR√ÅCTICA

Marca lo que ya completaste:

- [ ] Ejercicio 1: Error 400 (JSON mal formado)
- [ ] Ejercicio 2: Error 422 (Email inv√°lido)
- [ ] Ejercicio 3: Error 422 (Password corta)
- [ ] Ejercicio 4: Error 422 (M√∫ltiples errores)
- [ ] Ejercicio 5: √âxito 201 (Registro correcto)
- [ ] Ejercicio 6: Trackeo con request_id
- [ ] Ejercicio 7: Error 409 (Email duplicado)
- [ ] Ejercicio 8: Error 401 (Login fallido)
- [ ] Ejercicio 9: √âxito 200 (Login exitoso)
- [ ] Ejercicio 10: Error 401 (Token inv√°lido)
- [ ] Ejercicio 11: √âxito 200 (Acceso con token)
- [ ] Ejercicio 12: Ver logs filtrados

---

## üéØ DESAF√çO FINAL

Realiza un flujo completo de principio a fin:

1. Intenta registrar con email inv√°lido ‚Üí 422
2. Intenta registrar con password corta ‚Üí 422
3. Registra correctamente ‚Üí 201
4. Intenta registrar el mismo email ‚Üí 409
5. Intenta login con password incorrecta ‚Üí 401
6. Login correcto ‚Üí 200
7. Accede a tu perfil con el token ‚Üí 200
8. Busca todos los request_ids en los logs

**Tiempo estimado**: 10-15 minutos

---

## üí° PREGUNTAS DE AUTOEVALUACI√ìN

1. **¬øCu√°l es la diferencia entre 400 y 422?**
   - 400 = JSON mal formado (sintaxis)
   - 422 = JSON bien formado pero datos inv√°lidos (sem√°ntica)

2. **¬øCu√°ndo usar 409 vs 422?**
   - 409 = Conflicto de estado (ya existe)
   - 422 = Validaci√≥n fallida (formato incorrecto)

3. **¬øPara qu√© sirve el request_id?**
   - Para trackear una request espec√≠fica en los logs
   - Para debugging en producci√≥n

4. **¬øPor qu√© todos los errores vienen juntos en 422?**
   - Mejor experiencia de usuario
   - El usuario no tiene que corregir de uno en uno

5. **¬øQu√© c√≥digo HTTP se usa para registro exitoso?**
   - 201 Created (no 200)

---

## üöÄ PR√ìXIMOS PASOS

1. ‚úÖ Completa todos los ejercicios
2. ‚úÖ Intenta el desaf√≠o final
3. ‚úÖ Responde las preguntas de autoevaluaci√≥n
4. üìö Lee `EJEMPLOS_RESPUESTAS_API.md` para ver m√°s ejemplos
5. üîß Practica con Postman (gu√≠a en `PRACTICA_VALIDACION_TRACKEO.md`)
6. ü§ñ Ejecuta `./test_validacion.sh` para ver todos los tests automatizados

---

## ‚ùì SI ALGO NO FUNCIONA

### La API no inicia
```bash
# Verifica que est√°s en el directorio correcto
pwd  # Debe mostrar: /mnt/c/Users/aleja/solicitudes-api

# Verifica que tienes Python
python --version

# Verifica que tienes las dependencias
pip install -r requirements.txt

# Inicia la API
python wsgi.py
```

### No se crean los logs
```bash
# Crea el directorio manualmente
mkdir -p logs

# Verifica permisos
ls -la logs/
```

### curl no funciona
- Verifica que la API est√° corriendo en Terminal 1
- Verifica que el puerto 5000 est√° disponible
- Prueba con: `curl http://localhost:5000/health`

---

**¬°Disfruta practicando! üéâ**

**Tiempo total estimado**: 30-45 minutos
